#!/bin/sh
# Domain Puppy — pre-commit secret scanner
# Blocks commits that appear to contain API tokens or secrets.
#
# Install: cp hooks/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

ERRORS=0

# Patterns that indicate a hardcoded secret value (not a comment, not a placeholder)
SECRET_PATTERNS='
FASTLY_API_TOKEN\s*=\s*[A-Za-z0-9_\-]{20,}
CLOUDFLARE_API_TOKEN\s*=\s*[A-Za-z0-9_\-]{20,}
RAPIDAPI_KEY\s*=\s*[A-Za-z0-9_\-]{20,}
ALERT_WEBHOOK\s*=\s*https?://[^\s]{10,}
Authorization:\s*Bearer\s+[A-Za-z0-9_\-\.]{20,}
Fastly-Key:\s*[A-Za-z0-9_\-]{20,}
x-rapidapi-key:\s*[A-Za-z0-9_\-]{20,}
"fastlyApiToken"\s*:\s*"[A-Za-z0-9_\-]{20,}
wrangler\s+secret\s+put\s+\S+\s+\S{10,}
'

# Files that should never be staged
BLOCKED_FILES='.dev.vars .env credentials.json'

# Check for blocked filenames in staged files
for f in $BLOCKED_FILES; do
  if git diff --cached --name-only | grep -qF "$f"; then
    echo "ERROR: Blocked file staged for commit: $f"
    ERRORS=1
  fi
done

# Check staged file contents for secret patterns
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -n "$STAGED_FILES" ]; then
  # Write patterns to a temp file to avoid subshell variable scoping issue
  PATTERNFILE=$(mktemp)
  echo "$SECRET_PATTERNS" > "$PATTERNFILE"
  while IFS= read -r pattern; do
    [ -z "$pattern" ] && continue
    # Search staged content (not working tree) for the pattern
    if git diff --cached --diff-filter=ACM | grep -qE "^\+.*$pattern"; then
      echo "ERROR: Possible secret detected in staged changes (pattern: $pattern)"
      ERRORS=1
    fi
  done < "$PATTERNFILE"
  rm -f "$PATTERNFILE"
fi

# ---------------------------------------------------------------------------
# Version sync check — ensure SKILL.md versions match
# ---------------------------------------------------------------------------

if git diff --cached --name-only | grep -qF "SKILL.md"; then
  FRONT_VER=$(git show :SKILL.md | grep '^version:' | head -1 | awk '{print $2}')
  LOCAL_VER=$(git show :SKILL.md | grep 'LOCAL_VERSION=' | head -1 | sed 's/.*LOCAL_VERSION="\([^"]*\)".*/\1/')

  # Check that frontmatter and LOCAL_VERSION match each other
  if [ -n "$FRONT_VER" ] && [ -n "$LOCAL_VER" ] && [ "$FRONT_VER" != "$LOCAL_VER" ]; then
    echo "ERROR: Version mismatch in SKILL.md"
    echo "  frontmatter version: $FRONT_VER"
    echo "  LOCAL_VERSION:       $LOCAL_VER"
    echo ""
    echo "Run: ./hooks/bump-version.sh $FRONT_VER"
    ERRORS=1
  fi

  # Check that version was actually bumped (not same as last committed version)
  PREV_VER=$(git show HEAD:SKILL.md 2>/dev/null | grep '^version:' | head -1 | awk '{print $2}')
  if [ -n "$PREV_VER" ] && [ -n "$FRONT_VER" ] && [ "$PREV_VER" = "$FRONT_VER" ]; then
    echo "ERROR: SKILL.md changed but version was not bumped"
    echo "  current version: $FRONT_VER"
    echo ""
    echo "Run: ./hooks/bump-version.sh <new-version>"
    ERRORS=1
  fi
fi

if [ "$ERRORS" -ne 0 ]; then
  echo ""
  echo "Commit blocked. Fix the issues above before committing."
  exit 1
fi

exit 0
